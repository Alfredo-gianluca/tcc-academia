{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Aluno</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/estilo.css' %}" rel="stylesheet">
</head>
<body class="bg-dark text-white">
    <nav class="navbar navbar-custom fixed-top">
        <div class="container d-flex justify-content-center">
            <a class="navbar-brand brand-gradient mx-auto" href="{% url 'membros' %}">FitCore</a>
        </div>
    </nav>

    <main class="container fade-in" style="margin-top: 120px;">
        <h1 class="text-center gradient-purple mb-4">Editar Aluno: {{ aluno.nome_completo }}</h2>

        <form method="POST" action="{% url 'TelaProf:editar_aluno' aluno.id %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="observacoes">Observações</label>
                <textarea id="observacoes" name="observacoes">{{ aluno.observacoes }}</textarea>
            </div>

            <h3 class="section-title" style="margin-top: 2rem;">Calendário de Frequência</h3>


                <!-- Navegação -->
                <div class="calendar-month-navigation">
                    <button id="prevMonth" class="calendar-nav-button" type="button">◀ Anterior</button>
                    <span id="monthTitle" class="calendar-month-title"></span>
                    <button id="nextMonth" class="calendar-nav-button" type="button">Próximo ▶</button>
                </div>

                <!-- Container dos dias -->
                <div id="calendarContainer" class="calendar-container"></div>

                <!-- Legenda -->
                <div class="calendar-legend">
                    <div class="legend-item">
                        <span class="legend-box day-btn presente"></span> Presente
                    </div>
                    <div class="legend-item">
                        <span class="legend-box day-btn ausente"></span> Ausente
                    </div>
                </div>
            <!-- Campo oculto para enviar dados de presenças -->
            <input type="hidden" name="presencas_json" id="presencas_json">

            <div class="text-center mt-4">
                <button type="submit" class="btn-salvar">Salvar Alterações</button>
                <button type="button" class="btn-voltar">
                    <a href="{% url 'TelaProf:lista_alunos' %}" class="text-white text-decoration-none">Voltar</a>
                </button>
            </div>

        </form>
        
    </main>
    <footer class="footer text-center mt-5">
        <p style="margin-top: 10px;">&copy; 2025 FitCore. Todos os direitos reservados.</p>
    </footer>
    <script>
    const botoes = [
        {% for item in calendario %}
        {
            id: "{{ item.id }}",
            data: "{{ item.data|date:'Y-m-d' }}",
            presente: {{ item.presente|yesno:'true,false'|lower }}
        },
        {% endfor %}
    ];

    const presencas = {};
    botoes.forEach(btn => presencas[btn.id] = btn.presente);

    const calendarContainer = document.getElementById('calendarContainer');
    const monthTitle = document.getElementById('monthTitle');
    const inputPresencas = document.getElementById('presencas_json');

    // Agrupa os dias por mês
    const meses = {};
    botoes.forEach(b => {
        const data = new Date(b.data + 'T00:00:00'); // Força timezone local
        const key = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`; // +1 no mês
        if (!meses[key]) meses[key] = [];
        meses[key].push(b);
    });

    // Determina o ano base (pega o ano do primeiro registro ou o atual)
    const anoBase = botoes.length > 0 ? new Date(botoes[0].data + 'T00:00:00').getFullYear() : new Date().getFullYear();

    // Garante os 12 meses
    const todosMeses = [];
    for (let m = 1; m <= 12; m++) { // Meses de 1 a 12
        const chave = `${anoBase}-${String(m).padStart(2, '0')}`;
        todosMeses.push(chave);
        if (!meses[chave]) meses[chave] = [];
    }

    let indiceAtual = 0;

    function renderMes() {
        const chave = todosMeses[indiceAtual];
        const dias = meses[chave];
        const [ano, mes] = chave.split('-');
        const nomeMes = new Date(ano, parseInt(mes) - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }); // -1 no mês

        monthTitle.textContent = nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1);
        calendarContainer.innerHTML = '';

        const divMes = document.createElement('div');
        divMes.classList.add('calendar-month-container');

        if (dias.length === 0) {
            const vazio = document.createElement('p');
            vazio.textContent = 'Sem treinos registrados neste mês.';
            vazio.style.opacity = '0.6';
            vazio.style.fontStyle = 'italic';
            vazio.style.textAlign = 'center';
            vazio.style.gridColumn = '1 / -1';
            divMes.appendChild(vazio);
        } else {
            // Ordena os dias em ordem crescente
            dias.sort((a, b) => new Date(a.data + 'T00:00:00') - new Date(b.data + 'T00:00:00'));
            
            dias.forEach(item => {
                const d = new Date(item.data + 'T00:00:00'); // Força timezone local
                const dia = String(d.getDate()).padStart(2, '0');

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.classList.add('day-btn');
                btn.classList.toggle('presente', item.presente);
                btn.classList.toggle('ausente', !item.presente);
                btn.textContent = dia;

                btn.addEventListener('click', () => {
                    item.presente = !item.presente;
                    presencas[item.id] = item.presente;
                    btn.classList.toggle('presente', item.presente);
                    btn.classList.toggle('ausente', !item.presente);
                });

                divMes.appendChild(btn);
            });
        }

        calendarContainer.appendChild(divMes);
    }

    document.getElementById('prevMonth').addEventListener('click', () => {
        if (indiceAtual > 0) {
            indiceAtual--;
            renderMes();
        }
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        if (indiceAtual < todosMeses.length - 1) {
            indiceAtual++;
            renderMes();
        }
    });

    // Ao enviar o formulário
    document.querySelector('form').addEventListener('submit', () => {
        inputPresencas.value = JSON.stringify(presencas);
    });

    // Render inicial (Janeiro)
    renderMes();
</script>
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
</body>
</html>